<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Melody Creator</title>
    <script src="./scripts/tonal.min.js"></script>
    <script src="./scripts/Tone.min.js"></script>
    <script src="./scripts/jquery.min.js"></script>
    <script src="./scripts/nexusUI.min.js"></script>
    <script src="./scripts/teoria.js"></script>
    <link rel="stylesheet" href="css/melodicreator.css">
</head>

<body>
    <div id="Content">
        <div class="parameters">
            <select id="root_note" class="selection">
                <option selected value="A">Root Note</option>
                <option value="A">A</option>
                <option value="A#">A#-Bb</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="C#">C#-Db</option>
                <option value="D">D</option>
                <option value="D#">D#-Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#-Gb</option>
                <option value="G">G</option>
                <option value="G#">G#-Ab</option>
            </select>
            <select id="scale" class="selection">
                <option selected value="major">Scale</option>
                <option value="major">major</option>
                <option value="dorian">dorian</option>
                <option value="phrygian">phrygian</option>
                <option value="flamenco">flamenco</option>
                <option value="lydian">lydian</option>
                <option value="lydian augmented">lydian augmented</option>
                <option value="lydian dominant">lydian dominant</option>
                <option value="mixolydian">mixolydian</option>
                <option value="aeolian">aeolian</option>
                <option value="harmonic minor">harmonic minor</option>
                <option value="locrian">locrian</option>
                <option value="minor blues">blues</option>
                <option value="melodic minor">melodic minor</option>
                <option value="locrian major">locrian major</option>
                <option value="altered">altered</option>
                <option value="in-sen">in-sen</option>
                <option value="iwato">iwato</option>
                <option value="hirajoshi">hirajoshi</option>
                <option value="kumoijoshi">kumoijoshi</option>
                <option value="pelog">pelog</option>
                <option value="vietnamese 1">vietnamese</option>
                <option value="prometheus">prometheus</option>
                <option value="ritusen">ritusen</option>
                <option value="scriabin">scriabin</option>
                <option value="piongio">piongio</option>
                <option value="augmented">augmented</option>
                <option value="neopolitan">neopolitan</option>
                <option value="romanian minor">romanian minor</option>
                <option value="diminished">diminished</option>
                <option value="egyptian">egyptian</option>
                <option value="hungarian minor">hungarian minor</option>
            </select>
            <select id="octave" class="selection">
                <option selected value="3">Octave</option>
                <option value="0">C0 to C1</option>
                <option value="1">C1 to C2</option>
                <option value="2">C2 to C3</option>
                <option value="3">C3 to C4</option>
                <option value="4">C4 to C5</option>
                <option value="5">C5 to C6</option>
                <option value="6">C6 to C7</option>
            </select>
            <button id="set" class="">Set Scale</button>
        </div>
    </div>
    <div class="melodyDiv">
        <div class="notesInfo">
            <div data-key="65" class="key">
                <span id="1note" class="sound"></span>
            </div>
            <div data-key="83" class="key">
                <span id="2note" class="sound"></span>
            </div>
            <div data-key="68" class="key">
                <span id="3note" class="sound"></span>
            </div>
            <div data-key="70" class="key">
                <span id="4note" class="sound"></span>
            </div>
            <div data-key="71" class="key">
                <span id="5note" class="sound"></span>
            </div>
            <div data-key="72" class="key">
                <span id="6note" class="sound"></span>
            </div>
            <div data-key="74" class="key">
                <span id="7note" class="sound"></span>
            </div>
        </div>
        <canvas nx="matrix" id="notesMatrix" class="melodyBox"></canvas>
    </div>
    <div class="melodyDiv">
        <div class="arpegioInfo">
            <select id="oneNote" class="selectionArpegio" data-toggle="tooltip" title="One note per beat">
                <option selected>One Note</option>
            </select>
            <select id="twoNote" class="selectionArpegio" data-toggle="tooltip" title="Two notes arpeggio per beat">
                <option selected>Two Notes</option>
                <option value="0">Up</option>
                <option value="1">Down</option>
                <option value="2">Random</option>
            </select>
            <select id="threeNote" class="selectionArpegio" data-toggle="tooltip" title="Three notes arpeggio per beat">
                <option selected>Three Notes</option>
                <option value="0">Up</option>
                <option value="1">Down</option>
                <option value="2">Random</option>
            </select>
            <select id="fourNote" class="selectionArpegio" data-toggle="tooltip" title="Four notes arpeggio per beat">
                <option selected>Four Notes</option>
                <option value="0">Up</option>
                <option value="1">Down</option>
                <option value="2">Random</option>
            </select>
        </div>
        <div class="arpegioSelector">
            <canvas nx="matrix" id="arpegioMatrix" width="79%" height="25%"></canvas>
            <canvas nx="matrix" id="arpegioMatrix2" width="79%" height="25%"></canvas>
            <canvas nx="matrix" id="arpegioMatrix3" width="79%" height="25%"></canvas>
            <canvas nx="matrix" id="arpegioMatrix4" width="79%" height="25%"></canvas>
        </div>
    </div>
    <button id="play" class="">PLAY</button>
    <button id="stop" class="">STOP</button>
</body>

</html>
<script>
nx.onload = function() {
        nx.colorize("#ffc600")
        notesMatrix.row = 7
        notesMatrix.col = 8
        notesMatrix.init()


        arpegioMatrix.row = 1
        arpegioMatrix.col = 8
        arpegioMatrix2.row = 1
        arpegioMatrix2.col = 8
        arpegioMatrix3.row = 1
        arpegioMatrix3.col = 8
        arpegioMatrix4.row = 1
        arpegioMatrix4.col = 8
        arpegioMatrix.init()
        arpegioMatrix2.init()
        arpegioMatrix3.init()
        arpegioMatrix4.init()

    }
    // $(document).ready(function(){
    //     $('[data-toggle="tooltip"]').tooltip(); 
    // });
var chosenNote = $("#root_note").val();
var chosenScale = $("#scale").val();
var octave = $("#octave").val();
var escala = [];
// console.log(chosenNote)
// console.log(chosenScale)
// console.log(octave)

var sinte = new Tone.Synth({
    "oscillator": {
        "type": "square"
    },
    "envelope": {
        "attack": 0.01,
        "decay": 0.2,
        "sustain": 0.2,
        "release": 0.2,
    }
}).toMaster();



$("#set").on("click", () => {
    chosenNote = $("#root_note").val();
    // console.log(chosenNote)
    chosenScale = $("#scale").val();
    // console.log(chosenScale)
    octave = $("#octave").val();
    //here we decide wich mode use
    escala = Tonal.scale.get(chosenScale, chosenNote + octave);
    //setting the notes on the boxes
    $("#1note").text(`${escala[0]}`)
    $("#2note").text(`${escala[1]}`)
    $("#3note").text(`${escala[2]}`)
    $("#4note").text(`${escala[3]}`)
    $("#5note").text(`${escala[4]}`)
    $("#6note").text(`${escala[5]}`)
    $("#7note").text(`${escala[6]}`)

    return escala
})

var loop = new Tone.Sequence(function(time, col) {

    oneNoteTrigger(arpegioMatrix, escala, time, col)
    twoNoteTrigger(arpegioMatrix2, escala, time, col)
    threeNoteTrigger(arpegioMatrix3, escala, time, col)
    fourNoteTrigger(arpegioMatrix4, escala, time, col)

}, [0, 1, 2, 3, 4, 5, 6, 7], "4n");

Tone.Transport.bpm.value = 120

// function Root (escala){
//     console.log(`${escala[0]}`)
// }
function oneNoteTrigger(arpegioMatrix, escala, time, col) {
    
    arpegioMatrix.place = col;
    var column = arpegioMatrix.matrix[col];
    for (var i = 0; i < column.length; i++) {
        if (column[i] === 1) {
         sinte.triggerAttackRelease(`${escala[0]}`, '4n',time)   
        }
    }
   }

function twoNoteTrigger(arpegioMatrix2, escala, time, col) {
    arpegioMatrix2.place = col;

    var twoNoteSeq = new Tone.Sequence(function(time, note){
    var column = arpegioMatrix2.matrix[col];
    for (var i = 0; i < column.length; i++) {
        if (column[i] === 1) {
         sinte.triggerAttackRelease(note, '4n',time) 
        }
    }     

}, [[`${escala[0]}`, `${escala[2]}`],[null],[null],[null]],"8n")
    
    twoNoteSeq.loop = 2;
    twoNoteSeq.loopEnd = "2m";
    twoNoteSeq.start()
   }

function threeNoteTrigger(arpegioMatrix3, escala, time, col) {
 arpegioMatrix3.place = col;

    var threeNoteSeq = new Tone.Sequence(function(time, note){
    var column = arpegioMatrix3.matrix[col];
    for (var i = 0; i < column.length; i++) {
        if (column[i] === 1) {
         sinte.triggerAttackRelease(note, '4n',time) 
        }
    } 
   
}, [[`${escala[0]}`, `${escala[2]}`,`${escala[4]}`],[null],[null],[null]],"8n")
    
    threeNoteSeq.loop = 2;
    threeNoteSeq.loopEnd = "2m";
    threeNoteSeq.start()
   }


function fourNoteTrigger(arpegioMatrix4, escala, time, col) {
 arpegioMatrix4.place = col;

    var fourNoteSeq = new Tone.Sequence(function(time, note){
    var column = arpegioMatrix4.matrix[col];
    for (var i = 0; i < column.length; i++) {
        if (column[i] === 1) {
         sinte.triggerAttackRelease(note, '4n',time) 
        }
    } 
   
}, [[`${escala[0]}`, `${escala[2]}`,`${escala[4]}`,`${escala[6]}`],[null],[null],[null]],"8n")
    
    fourNoteSeq.loop = 2;
    fourNoteSeq.loopEnd = "2m";
    fourNoteSeq.start()
   }

$("#play").on("click", () => {


    Tone.Transport.start()
    loop.start()


    arpegioMatrix.sequence(Tone.Transport.bpm.value)
    arpegioMatrix2.sequence(Tone.Transport.bpm.value)
    arpegioMatrix3.sequence(Tone.Transport.bpm.value)
    arpegioMatrix4.sequence(Tone.Transport.bpm.value)
    arpegioMatrix.init()
    arpegioMatrix2.init()
    arpegioMatrix3.init()
    arpegioMatrix4.init()


})
$("#stop").on("click", () => {

    // loop.stop()
    arpegioMatrix.stop()
    arpegioMatrix2.stop()
    arpegioMatrix3.stop()
    arpegioMatrix4.stop()


    Tone.Transport.stop()
})
</script>
