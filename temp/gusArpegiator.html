<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Arpeggiator</title>
    <script src="./scripts/Tone.min.js"></script>
    <script src="./scripts/jquery.min.js"></script>
    <script src="./scripts/Interface.js"></script>
    <script src="./scripts/nexusUI.js"></script>
    <script src="./scripts/teoria.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="Content">
        <div class="parameters">

            <select id="root_note" class="selection">
                <option selected>Root Note</option>
                <option value="A">A</option>
                <option value="A#">A#-Bb</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="C#">C#-Db</option>
                <option value="D">D</option>
                <option value="D#">D#-Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#-Gb</option>
                <option value="G">G</option>
                <option value="G#">G#-Ab</option>
            </select>
            <select id="scale" class="selection">
                <option selected>Scale</option>
                <option value="ionian">ionian</option>
                <option value="dorian">dorian</option>
                <option value="phrygian">phrygian</option>
                <option value="flamenco">flamenco</option>
                <option value="lydian">lydian</option>
                <option value="mixolydian">mixolydian</option>
                <option value="aeolian">aeolian</option>
                <option value="harmonicminor">harmonicminor</option>
                <option value="locrian">locrian</option>
                <option value="blues">blues</option>
                <option value="majorpentatonic">majorpentatonic</option>
                <option value="minorpentatonic">minorpentatonic</option>
                <option value="chromatic">chromatic</option>
                <option value="wholetone">wholetone</option>
                <option value="harmonicchromatic">harmonicchromatic</option>
                <option value="doubleharmonic">doubleharmonic</option>
            </select>
            <button id="set" class="key">Set Scale</button>
            <button id="play" class="key">PLAY</button>
            <button id="stop" class="key">STOP</button>
            
            <canvas nx="dial" id="tempo" label="BPM" min="60" max="220"></canvas>
        </div>
        <div class="keys">
            <div data-key="65" class="key">
                <p>A</p>
                <span id="A" class="sound"></span>
            </div>
            <div data-key="83" class="key">
                <p>S</p>
                <span id="S" class="sound"></span>
            </div>
            <div data-key="68" class="key">
                <p>D</p>
                <span id="D" class="sound"></span>
            </div>
            <div data-key="70" class="key">
                <p>F</p>
                <span id="F" class="sound"></span>
            </div>
            <div data-key="71" class="key">
                <p>G</p>
                <span id="G" class="sound"></span>
            </div>
            <div data-key="72" class="key">
                <p>H</p>
                <span id="H" class="sound"></span>
            </div>
            <div data-key="74" class="key">
                <p>J</p>
                <span id="J" class="sound"></span>
            </div>
            <div data-key="75" class="key">
                <p>K</p>
                <span id="K" class="sound"></span>
            </div>
            
        </div>
            
            <p>DRUM MACHINE</p>
            <canvas nx="matrix" id="drumMatrix"></canvas>
            <p>SEQUENCER</p>
            <canvas nx="matrix"></canvas>
        <script>
        // const tonal = require ('tonal')
        //patterns
        // var threeNotePatterns = [ [`${escala[0].toUpperCase()+4}`, ` ${escala[2].toUpperCase()+4}`, `${escala[4].toUpperCase()+4}`],[`${escala[2].toUpperCase()+4}`, ` ${escala[4].toUpperCase()+4}`, `${escala[0].toUpperCase()+4}`],[`${escala[4].toUpperCase()+4}`, ` ${escala[0].toUpperCase()+4}`, `${escala[2].toUpperCase()+4}`]]

        var note = ""
        var key = 0
        var actualScale = ""
        var escala = []
        var tempo = 120
        
        
        
        //starting the drumMatrix and the Transport
        $("#play").on("click", () => {
        drumMatrix.place= 0 
        
        Tone.Transport.bpm.value = 120
        
        //stoping the drumMatrix and the Transport
        Tone.Transport.start()
         loop.start()                        })
        $("#stop").on("click", () => {
        drumMatrix.stop()
        drumMatrix.place= 0 
        Tone.Transport.stop()})

        //setting the notes of the chosen scale&root into the boxes
        $("#set").on("click", () => {
            var chosenNote = $("#root_note").val();
            console.log(chosenNote)
            
            //here we set the root note
            note = teoria.note(chosenNote)
            console.log(note)
            var chosenScale = $("#scale").val();
            console.log(chosenScale)
            //here we decide wich mode use
            escala = note.scale(chosenScale).simple();
            //setting the notes on the boxes
            $("#A").text(`${escala[0].toUpperCase()}`)
            $("#S").text(`${escala[1].toUpperCase()}`)
            $("#D").text(`${escala[2].toUpperCase()}`)
            $("#F").text(`${escala[3].toUpperCase()}`)
            $("#G").text(`${escala[4].toUpperCase()}`)
            $("#H").text(`${escala[5].toUpperCase()}`)
            $("#J").text(`${escala[6].toUpperCase()}`)
            $("#K").text(`${escala[0].toUpperCase()}`)

            console.log(escala)
            return escala
        })

        //here we set the Tone notes that will sound in real time in the boxes
        window.addEventListener('keydown', function(event) {
            //witch key is pressed in the exact moment
            key = `${event.keyCode}`
            console.log(key)
            console.log(`${escala[0].toUpperCase()+4}`)
            var synth = new Tone.Synth().toMaster()
            // parsing the notes into ToneJS format
            if (key == 65) {
                synth.triggerAttackRelease(`${escala[0].toUpperCase()+4}`, '8n')
            }
            if (key == 83) {
                synth.triggerAttackRelease(`${escala[1].toUpperCase()+4}`, '8n')
            }
            if (key == 68) {
                synth.triggerAttackRelease(`${escala[2].toUpperCase()+4}`, '8n')
            }
            if (key == 70) {
                synth.triggerAttackRelease(`${escala[3].toUpperCase()+4}`, '8n')
            }
            if (key == 71) {
                synth.triggerAttackRelease(`${escala[4].toUpperCase()+4}`, '8n')
            }
            if (key == 72) {
                synth.triggerAttackRelease(`${escala[5].toUpperCase()+4}`, '8n')
            }
            if (key == 74) {
                synth.triggerAttackRelease(`${escala[6].toUpperCase()+4}`, '8n')
            }
            if (key == 75) {
                synth.triggerAttackRelease(`${escala[0].toUpperCase()+5}`, '8n')
            }


        })

        //sequencer

        // var piano = new Tone.Synth({
        //     "oscillator" : {
        //         "type" : "fmsine4",
        //         "modulationType" : "square"
        //     }
        // }).toMaster();

        // var loop = new Tone.Pattern(function(time, note){
        //     piano.triggerAttackRelease(note, "16n", time);

        //     // Draw.schedule takes a callback and a time to invoke the callback
        //     Tone.Draw.schedule(function(){
        //         //the callback synced to the animation frame at the given time
        //         $("#"+note).css("opacity", 1).animate({"opacity" : 0}, 300)
        //     }, time);
        // }, ["C4", "E4", "G4", "B4", "D5"]).start(0);

        // loop.interval = "16n";
        var drumSampler = new Tone.MultiPlayer({
            urls: {
                "sP": "./samples/snarePunch.mp3",
                "kP": "./samples/kickPunch.mp3",
                "hh": "./samples/hihat.mp3",
                "s": "./samples/snare.mp3",
            },
            volume: -6,
            fadeOut: 0.1,
        }).toMaster();

        //the notes
        var drumSound = ["kP", "sP", "hh", "s"];

        var loop = new Tone.Sequence(function(time, col) {
            var column = drumMatrix.matrix[col];
            for (var i = 0; i < 4; i++) {
                if (column[i] === 1) {
                    //setting random velocities for each drum sample
                    var vel = Math.random() * 0.5 + 0.5;
                    drumSampler.start(drumSound[i], time, 0, "32n", 0,vel);
                }
            }
            // Tone.Draw.schedule(function(){
            //     //the callback synced to the animation frame at the given time
            //     $("matrix2").css("opacity", 1).animate({"opacity" : 0}, 300)
            // }, time);
        }, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], "4n");


         loop.start()
 
        

        //GUI

        nx.onload = function() {

            
            
            drumMatrix.sequence(120)
            
            //drum machine matrix
            nx.colorize("#ffc600")
           
            
            drumMatrix.row = 4
            drumMatrix.col = 16
            // drumMatrix.bpm = tempo
            drumMatrix.resize($("#Content").width(), 300)
            drumMatrix.init()
            //sequencer matrix
            nx.colorize("#ffc600")
            
            matrix2.row = 8
            matrix2.col = 16
            matrix2.resize($("#Content").width(), 300);
            matrix2.init()

        }

        </script>
</body>

</html>
